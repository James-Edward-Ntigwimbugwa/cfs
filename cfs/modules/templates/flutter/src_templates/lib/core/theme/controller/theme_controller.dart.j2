import 'package:flutter/material.dart';

import '../../enums/app_theme.dart';
import '../../injection/dependency_injection.dart';
import '../../storage/flutter_secure_storage_keys.dart';
import '../../storage/flutter_secure_storage_service.dart';

class ThemeController extends ChangeNotifier {
  final _secureStorage = getIt<FlutterSecureStorageService>();

  AppThemeMode _themeMode = AppThemeMode.system;

  ThemeController() {
    _loadThemeOnInit(); // ✅ automatically load theme when constructed
  }

  AppThemeMode get themeMode => _themeMode;

  ThemeMode get appThemeMode {
    switch (_themeMode) {
      case AppThemeMode.light:
        return ThemeMode.light;
      case AppThemeMode.dark:
        return ThemeMode.dark;
      case AppThemeMode.system:
        return ThemeMode.system;
    }
  }

  bool get isDark => _themeMode == AppThemeMode.dark;

  Future<void> setTheme(AppThemeMode newMode) async {
    if (newMode != _themeMode) {
      _themeMode = newMode;
      await _secureStorage.saveItem(
        key: FlutterSecureStorageKeys.themeKey,
        value: newMode.name,
      );
      notifyListeners();
    }
  }

  Future<void> toggleTheme() async {
    if (_themeMode == AppThemeMode.dark) {
      await setTheme(AppThemeMode.light);
    } else {
      await setTheme(AppThemeMode.dark);
    }
  }

  /// Loads theme from secure storage
  Future<void> loadTheme() async {
    final saved = await _secureStorage.getItem(key: FlutterSecureStorageKeys.themeKey);
    if (saved != null) {
      try {
        _themeMode = AppThemeMode.values
            .firstWhere((mode) => mode.name == saved, orElse: () => AppThemeMode.system);
      } catch (_) {
        _themeMode = AppThemeMode.system;
      }
      notifyListeners();
    }
  }

  /// Called automatically in constructor
  void _loadThemeOnInit() {
    // Fire and forget (don’t block UI startup)
    loadTheme();
  }
}
