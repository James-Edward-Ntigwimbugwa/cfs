import 'package:graphql_flutter/graphql_flutter.dart';
import '../models/user_model.dart';
import '../graphql/queries.dart';
import '../graphql/mutations.dart';

/// Repository for User data operations
class UserRepository {
  final GraphQLClient _client;

  UserRepository(this._client);

  /// Fetch all users
  Future<List<UserModel>> getAllUsers() async {
    final result = await _client.query(
      QueryOptions(
        document: gql(UserQueries.getAllUsers),
        fetchPolicy: FetchPolicy.networkOnly,
      ),
    );

    if (result.hasException) {
      throw Exception(result.exception.toString());
    }

    final List<dynamic> usersData = result.data?['users'] ?? [];
    return usersData.map((json) => UserModel.fromJson(json)).toList();
  }

  /// Fetch user by ID
  Future<UserModel> getUserById(String id) async {
    final result = await _client.query(
      QueryOptions(
        document: gql(UserQueries.getUserById),
        variables: {'id': id},
        fetchPolicy: FetchPolicy.networkOnly,
      ),
    );

    if (result.hasException) {
      throw Exception(result.exception.toString());
    }

    return UserModel.fromJson(result.data?['user']);
  }

  /// Create a new user
  Future<UserModel> createUser({
    required String name,
    required String email,
    String? avatar,
    String? bio,
  }) async {
    final result = await _client.mutate(
      MutationOptions(
        document: gql(UserMutations.createUser),
        variables: {
          'input': {
            'name': name,
            'email': email,
            if (avatar != null) 'avatar': avatar,
            if (bio != null) 'bio': bio,
          },
        },
      ),
    );

    if (result.hasException) {
      throw Exception(result.exception.toString());
    }

    return UserModel.fromJson(result.data?['createUser']);
  }

  /// Update an existing user
  Future<UserModel> updateUser({
    required String id,
    String? name,
    String? email,
    String? avatar,
    String? bio,
  }) async {
    final result = await _client.mutate(
      MutationOptions(
        document: gql(UserMutations.updateUser),
        variables: {
          'id': id,
          'input': {
            if (name != null) 'name': name,
            if (email != null) 'email': email,
            if (avatar != null) 'avatar': avatar,
            if (bio != null) 'bio': bio,
          },
        },
      ),
    );

    if (result.hasException) {
      throw Exception(result.exception.toString());
    }

    return UserModel.fromJson(result.data?['updateUser']);
  }

  /// Delete a user
  Future<bool> deleteUser(String id) async {
    final result = await _client.mutate(
      MutationOptions(
        document: gql(UserMutations.deleteUser),
        variables: {'id': id},
      ),
    );

    if (result.hasException) {
      throw Exception(result.exception.toString());
    }

    return result.data?['deleteUser']?['success'] ?? false;
  }

  /// Search users by query
  Future<List<UserModel>> searchUsers(String query) async {
    final result = await _client.query(
      QueryOptions(
        document: gql(UserQueries.searchUsers),
        variables: {'query': query},
        fetchPolicy: FetchPolicy.networkOnly,
      ),
    );

    if (result.hasException) {
      throw Exception(result.exception.toString());
    }

    final List<dynamic> usersData = result.data?['searchUsers'] ?? [];
    return usersData.map((json) => UserModel.fromJson(json)).toList();
  }
}