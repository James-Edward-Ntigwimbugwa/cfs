from urllib.parse import urlparse
from dotenv import dotenv_values

from {{package_name}}_backend.settings.base import BASE_DIR
from .base import *

config = dotenv_values(".env")

DEBUG = True

ALLOWED_HOSTS = ['*']
SECRET_KEY = config['SECRET_KEY']

# Get DATABASE_URL from environment or use default SQLite
try:
    database_url = config['LOCAL_DATABASE_URL']
except Exception as e:
    database_url = 'sqlite:///db.sqlite3'

# Parse the database URL
url = urlparse(database_url)

# Map scheme to Django engine
ENGINE_MAPPING = {
    'postgres': 'django.db.backends.postgresql',
    'postgresql': 'django.db.backends.postgresql',
    'pgsql': 'django.db.backends.postgresql',
    'mysql': 'django.db.backends.mysql',
    'sqlite': 'django.db.backends.sqlite3',
    'oracle': 'django.db.backends.oracle',
}

engine = ENGINE_MAPPING.get(url.scheme)

if not engine:
    raise ValueError(f"Unsupported database engine: {url.scheme}")


DATABASES = {
    'default': {
        'ENGINE': engine,
        'NAME': url.path[1:] if url.path else '', 
        'USER': url.username or '',
        'PASSWORD': url.password or '',
        'HOST': url.hostname or '',
        'PORT': url.port or '',
        'CONN_MAX_AGE': 600,
        'OPTIONS': {
            'sslmode': 'prefer',
        } if engine == 'django.db.backends.postgresql' else {},
    }
}

AUTH_PASSWORD_VALIDATORS = [
    {
        "NAME": "{{package_name}}_utils.validators.password_validator.ContainsUppercaseValidator",
        "OPTIONS": {"min_uppercase": 1},
    },
    {
        "NAME": "{{package_name}}_utils.validators.password_validator.ContainsLowercaseValidator",
    },
    {
        "NAME": "{{package_name}}_utils.validators.password_validator.ContainsDigitsValidator",
    },
    {
        "NAME": "{{package_name}}_utils.validators.password_validator.ContainsSpecialCharactersValidator",
    },
    {
        "NAME": "{{package_name}}_utils.validators.password_validator.MaximumLengthValidator",
        "OPTIONS": {"max_length": 50},
    },
    {
        "NAME": "{{package_name}}_utils.validators.password_validator.MaxConsecutiveCharactersValidator",
        "OPTIONS": {"max_consecutive": 3},
    },
    {
        "NAME": "{{package_name}}_utils.validators.password_validator.ConsecutivelyIncreasingDigitValidator",
    },
    {
        "NAME": "{{package_name}}_utils.validators.password_validator.ConsecutivelyDecreasingDigitValidator",
    },
]


# LDAP CONFIGURATIONS
AUTHENTICATION_BACKENDS = [
    "django.contrib.auth.backends.ModelBackend",
]

# LOGS
# Logging Configurations
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {name} {module} {process:d} {message}',
            'style': '{',
        },

        'console': {
            'format': '{levelname} {asctime} {process:d} {name} {funcName} {message} {pathname} {lineno}',
            'style': '{',
        },
        'file': {
            'format': '{levelname} {asctime} {process:d} {module} {name} {funcName} {message} {pathname} {lineno}',
            'style': '{',
        },

        'simple': {
            'format': '{levelname} {asctime} {name} {module} {message}',
            'style': '{',
        },
    },

    'handlers': {
        'console': {
            'class': 'logging.StreamHandler',
            'formatter': 'verbose'
        },
        'file': {
            'class': 'logging.FileHandler',
            'formatter': 'file',
            'filename': BASE_DIR / '{{package_name}}_logs/debug.log',
        }
    },

    'loggers': {
        '': {
            'handlers': ['console', 'file'],
            'level': 'DEBUG',
            'propagate': True,
        },
        'django': {
            'handlers': ['file', 'console'],
            'propagate': True,
        },
    }
}


