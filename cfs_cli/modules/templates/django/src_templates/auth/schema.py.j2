import logging
import graphene
from django.db.models import Q
from {{package_name}}_auth.models import *
from {{package_name}}_utils.decorators.permission import *
from {{package_name}}_dto.auth_dto import *
from {{package_name}}_dto.enums import AccountsTypeChoices
from {{package_name}}_dto_builders.auth_dto_builder import AuthBuilder
from {{package_name}}_dto_builders.response_builder import build_response
from {{package_name}}_utils.user_utils import UserUtils

logger = logging.getLogger(__name__)


class Query(graphene.ObjectType):
    get_all_system_permissions = graphene.Field(
        UserPermissionsGroupResponseObject, filtering=UserPermissionsFilterInput())
    get_all_system_roles = graphene.Field(
        UserRolesResponseObject, filtering=UserrRoleFilterInput())

    # @has_query_access(permissions=['can_list_system_permissions'],user_types=[AccountsType.SYSTEM_ADMIN.value, AccountsType.ORGANIZATION.value])
    def resolve_get_all_system_permissions(self, info, filtering=None, **kwargs):
        filters = Q(is_active=True)
        return build_response(UserPermissionsGroup, filters, AuthBuilder.get_permission_group_data, info)

    # @login_required()
    def resolve_get_all_system_roles(self, info, filtering=None, **kwargs):
        filters = Q(is_active=True)
        user_type = UserUtils.__usertype__(request=info.context)

        # Apply optional filtering from GraphQL input
        if filtering:
            if filtering.role_type:
                filters &= Q(role_type=filtering.role_type.value)
        else:
            # Role visibility rules based on user account type
            if user_type == AccountsTypeChoices.MANUFACTURER.value:
                # Organization accounts may only see ORGANIZATION roles
                filters &= Q(role_type=RoleTyeChoices.ORGANIZATION.value)

            elif user_type == AccountsTypeChoices.AGENT.value:
                # Individual accounts may only see INDIVIDUAL roles
                filters &= Q(role_type=RoleTyeChoices.INDIVIDUAL.value)

        # Build and return the response
        return build_response(UserRoles, filters, AuthBuilder.get_role_data, info)
