import logging
from dotenv import dotenv_values
from celery import shared_task
import graphene
from {{package_name}}_dto.enums import InAppNotificationTypeChoices
from {{package_name}}_notifications.tasks import handle_new_notification
from {{package_name}}_utils.notifications_utils import NotificationServices

config = dotenv_values('.env')
logger = logging.getLogger(__name__)
FRONTEND_URL = config['FRONTEND_URL']


class NotificationService:

    @staticmethod
    @shared_task
    def send_notification(message, subject, template, receivers, callback_item=None, item_type=None, cc_list=None, sender=None, extra_context=None):
        """
        Generic function to send in-app and email notifications.
        :param message: Text message for in-app notification.
        :param subject: Email subject.
        :param template: Email template path.
        :param receivers: List of Profile objects to receive notifications.
        :param callback_item: Reference item ID/UID.
        :param item_type: In-app notification type.
        :param cc_list: Optional list of CC email addresses.
        :param sender: Sender profile (optional).
        :param extra_context: Additional context for email template.
        """
        for receiver in receivers:
            # In-app notification
            handle_new_notification(
                {
                    "message": message,
                    "sender": sender,
                    "receiver": receiver,
                    "callback_item": callback_item,
                    "item_type": item_type,
                }
            )

            # Email notification
            body = {
                "receiver": receiver,
                "receiver_details": receiver.user.email,
                "subject": subject,
                "front_end_url": FRONTEND_URL,
                "cc_list": cc_list or []
            }
            if extra_context:
                body.update(extra_context)
            NotificationServices.send_email_notification(body, template)
        return True

    @staticmethod
    @shared_task
    def send_notification_via_code(receivers, code, context=None, callback_item=None, item_type=None, sender=None, html_template=None):
        """
        Send notifications (in-app + email) using a NOTIFICATION_MAP code.
        Works with both:
          - receivers = list of Profile/User objects
          - receivers = list of email strings
        """
        try:
            context = context or {}

            # Base context defaults
            base_context = {"front_end_url": context.get(
                "front_end_url", FRONTEND_URL), "signature": "{{ package_name | replace('_', ' ') | upper }} Team"}

            for receiver in receivers:
                # When receiver is a string email
                if isinstance(receiver, str):
                    receiver_email = receiver
                    receiver_name = context.get("UserFullName", receiver)
                    receiver_obj = receiver

                # CASE 2: receiver is a Profile/User object
                else:
                    receiver_email = getattr(receiver, "email", None)
                    if not receiver_email and hasattr(receiver, "user"):
                        receiver_email = receiver.user.email

                    receiver_name = None
                    if hasattr(receiver, "get_full_name"):
                        receiver_name = receiver.get_full_name()
                    elif hasattr(receiver, "user"):
                        receiver_name = receiver.user.get_full_name()
                    receiver_obj = receiver

                # Build final email context
                email_context = {
                    **base_context,
                    "receiver_email": receiver_email,
                    "UserFullName": receiver_name or "Valued Partner",
                }
                email_context.update(context)

                # In-app notification only if receiver is a real profile/user
                if receiver_obj:
                    handle_new_notification({
                        "message": f"New notification: {str(code).replace('_', ' ').title()}",
                        "sender": sender,
                        "receiver": receiver_obj,
                        "callback_item": callback_item,
                        "item_type": item_type or InAppNotificationTypeChoices.GENERAL.value,
                    })

                # Send email through unified notification engine
                NotificationServices.send(code, email_context, html_template)

            return True

        except Exception as e:
            logger.error(f"Error sending notification via code '{code}': {e}")
            return False


class Mutation(graphene.ObjectType):
    pass
